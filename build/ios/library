#!/bin/sh
set -e
ROOTDIR=$(cd `dirname "$0"` && pwd -P)

if [ "$1" = "-b" ]; then
    echo "Downloading and verifying binary release from github"
    RELEASE_URL=https://github.com/measurement-kit/measurement-kit/releases/download/v0.6.0-beta/ios_frameworks-0.6.0-beta.zip
    RELEASE_FILE=`basename $RELEASE_URL`
    curl --progress-bar -LO $RELEASE_URL
    curl --progress-bar -LO $RELEASE_URL.asc
    gpg2 --verify $RELEASE_FILE.asc
    unzip $RELEASE_FILE
    exit 0
fi

echo "Downloading and verifying precompiled dependencies from github"
(
    set -e # just in case
    cd $ROOTDIR
    DEPS_URL=https://github.com/measurement-kit/dependencies/releases/download/2017-04-03/ios-dependencies-20170404T102613Z.tgz
    DEPS_FILE=$(basename $DEPS_URL)
    curl --progress-bar -LO $DEPS_URL
    curl --progress-bar -LO $DEPS_URL.asc
    gpg2 --verify $DEPS_FILE.asc
    tar -xzf $DEPS_FILE
    rm $DEPS_FILE $DEPS_FILE.asc
)

$ROOTDIR/dependency mk
$ROOTDIR/build-frameworks
